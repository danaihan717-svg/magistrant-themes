<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="UTF-8">
<title>Магистрант тақырып таңдауы</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{font-family:Arial;margin:20px;background:#f8f9fa;}
h1{color:#2c3e50;}
.hidden{display:none;}
.form-box{background:white;padding:20px;border-radius:10px;width:320px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
input{width:100%;padding:8px;margin:6px 0 12px;border:1px solid #ccc;border-radius:5px;}
button{padding:10px 15px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;margin-top:5px;}
button:hover{background:#0056b3;}
.center-block{margin-bottom:10px;background:white;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.center-header{padding:12px;background:#e9ecef;cursor:pointer;border-radius:8px 8px 0 0;font-weight:bold;}
.topics{display:none;padding:10px;}
.topic{margin:5px 0;padding:8px;border-radius:5px;cursor:pointer;}
.taken{background:#f8d7da;color:#721c24;}
.free{background:#d4edda;color:#155724;}
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.my-choice{background:#fff3cd;border:1px solid #ffeeba;padding:15px;border-radius:10px;margin-bottom:20px;}
.lang-select{margin-left:10px;padding:3px;border-radius:5px;}
</style>
</head>
<body>
<h1>🎓 Магистрант тақырып таңдау</h1>

<div id="loginForm" class="form-box">
<label>ИИН:</label>
<input type="password" id="iin" placeholder="ИИН енгізіңіз">
<button onclick="login()">Кіру</button>
<p class="error" id="loginError"></p>
</div>

<div id="main" class="hidden">
<div class="top-bar">
<div>
👤 <b id="studentName"></b>
<select id="lang" class="lang-select" onchange="renderCenters(lastCenters)"><option value="kk">KK</option><option value="ru">RU</option></select>
</div>
<div id="adminButtons" class="hidden">
<button onclick="downloadReport()">📥 Отчёт (CSV)</button>
<button onclick="clearAll()">🧹 Барлығын тазалау</button>
<button onclick="logout()">🚪 Шығу</button>
</div>
<div id="studentButtons" class="hidden">
<button onclick="logout()">🚪 Шығу</button>
</div>
</div>

<div id="myChoice" class="my-choice hidden"></div>
<h2 id="centersTitle">📚 Орталықтар</h2>
<div id="centers"></div>

<script>
const socket=io();
let currentFio=null;
let isAdmin=false;
let lastCenters=[]; // для повторного рендера при смене языка

function login(){
    const iin=document.getElementById("iin").value.trim();
    if(!iin){ document.getElementById("loginError").textContent="⚠️ ИИН енгізіңіз!"; return; }
    socket.emit("registerStudent",{iin});
}

socket.on("authError",msg=>document.getElementById("loginError").textContent=msg);

socket.on("topicsList",(centers,admin,fio)=>{
    currentFio=fio; isAdmin=admin;
    lastCenters=centers;
    document.getElementById("studentName").textContent=fio;
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");
    if(admin){ document.getElementById("adminButtons").classList.remove("hidden"); document.getElementById("studentButtons").classList.add("hidden"); }
    else{ document.getElementById("adminButtons").classList.add("hidden"); document.getElementById("studentButtons").classList.remove("hidden"); }
    renderCenters(centers);
});

function renderCenters(centers){
    const lang=document.getElementById("lang").value;
    const container=document.getElementById("centers");
    container.innerHTML="";
    let myTopic=null,myCenter=null;

    centers.forEach(center=>{
        center.topics.forEach(topic=>{
            if(topic.student===currentFio){ myTopic=topic; myCenter=center; }
        });
    });

    if(!isAdmin && myTopic){
        document.getElementById("myChoice").classList.remove("hidden");
        document.getElementById("centersTitle").classList.add("hidden");
        container.classList.add("hidden");
        document.getElementById("myChoice").textContent=`✅ Сіз таңдадыңыз: ${myTopic.title[lang]} (${myCenter.name[lang]}) — ${myTopic.time}`;
        return;
    }

    document.getElementById("myChoice").classList.add("hidden");
    document.getElementById("centersTitle").classList.remove("hidden");
    container.classList.remove("hidden");

    centers.forEach(center=>{
        const block=document.createElement("div");
        block.className="center-block";
        const header=document.createElement("div");
        header.className="center-header";
        header.textContent=center.name[lang];
        header.onclick=()=>{ const topicsDiv=block.querySelector(".topics"); topicsDiv.style.display=(topicsDiv.style.display==="none")?"block":"none"; };
        block.appendChild(header);

        const topicsDiv=document.createElement("div");
        topicsDiv.className="topics";

        center.topics.forEach(topic=>{
            const div=document.createElement("div");
            div.className="topic "+(topic.student?"taken":"free");
            div.textContent=`${topic.id}. ${topic.title[lang]} ${topic.student? " — "+topic.student+" ("+topic.time+")":""}`;
            if(!topic.student && !isAdmin){ div.onclick=()=>{ if(confirm(`Сіз таңдадыңыз ба: "${topic.title[lang]}"?`)) socket.emit("chooseTopic",{fio:currentFio,centerName:center,topicId:topic.id}); }; }
            topicsDiv.appendChild(div);
        });
        block.appendChild(topicsDiv);
        container.appendChild(block);
    });
}

function logout(){ location.reload(); }
function downloadReport(){ window.location="/downloadReport"; }
function clearAll(){ if(confirm("⚠️ Барлық таңдалған тақырыптарды тазалау керек пе?")) socket.emit("clearAll"); }

socket.on("topicError",msg=>alert(msg));
</script>
</body>
</html>
