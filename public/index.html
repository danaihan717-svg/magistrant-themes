<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="utf-8" />
<title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa}
  h1{color:#2c3e50}
  .form-box{background:#fff;padding:16px;border-radius:8px;width:340px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  input,select,button{padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
  button{background:#007bff;color:#fff;border:none;cursor:pointer}
  button:hover{opacity:0.95}
  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
  .center-block{background:#fff;border-radius:8px;margin-top:10px;padding:0;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
  .center-header{padding:12px;background:#e9ecef;border-radius:8px 8px 0 0;font-weight:bold;cursor:pointer}
  .topics{padding:10px;display:none}
  .topic{padding:8px;border-radius:6px;margin-bottom:6px}
  .free{background:#e9f7ec;color:#155724;cursor:pointer}
  .taken{background:#f8d7da;color:#721c24}
  .my-choice{background:#fff8e1;border:1px solid #ffeeba;padding:12px;border-radius:8px;margin-top:12px}
  .hidden{display:none}
</style>
</head>
<body>
  <h1>üéì –ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –∂“Ø–π–µ—Å—ñ</h1>

  <div id="loginForm" class="form-box">
    <label>–ò–ò–ù:</label><br>
    <input id="iin" type="text" placeholder="–ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" /><br>
    <label>–¢—ñ–ª / –Ø–∑—ã–∫:</label><br>
    <select id="langSelect">
      <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select><br>
    <button onclick="login()">–ö—ñ—Ä—É / –í–æ–π—Ç–∏</button>
    <p id="loginError" style="color:red"></p>
  </div>

  <div id="main" class="hidden">
    <div class="top-bar">
      <div>üë§ <b id="studentName"></b></div>
      <div>
        <div id="adminButtons" class="hidden">
          <button onclick="downloadReport()">üì• –û—Ç—á—ë—Ç (CSV)</button>
          <button onclick="clearAll()">üßπ –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞–ª–∞—É</button>
          <button onclick="logout()">üö™ –®—ã“ì—É</button>
        </div>
        <div id="studentButtons" class="hidden">
          <button onclick="logout()">üö™ –®—ã“ì—É</button>
        </div>
      </div>
    </div>

    <div id="myChoice" class="my-choice hidden"></div>

    <h2 id="centersTitle">üìö –û—Ä—Ç–∞–ª—ã“õ—Ç–∞—Ä</h2>
    <div id="centersContainer"></div>
  </div>

<script>
const socket = io();
let currentFio = null;
let isAdmin = false;
let currentLang = 'kk';
let lastCenters = [];

// –í—Ö–æ–¥
function login(){
  const iin = document.getElementById('iin').value.trim();
  currentLang = document.getElementById('langSelect').value;
  if(!iin){ document.getElementById('loginError').textContent = '‚ö†Ô∏è –ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!'; return; }
  document.getElementById('loginError').textContent = '';
  socket.emit('registerStudent',{ iin, lang: currentLang });
}

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ—Ç —ç–≤–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–∫–µ—Ç–∞
socket.on('authSuccess', ({ fio, isAdmin: adminFlag, centers, lang }) => {
  currentFio = fio;
  isAdmin = adminFlag;
  currentLang = lang || currentLang;
  lastCenters = centers;

  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  document.getElementById('studentName').textContent = currentFio;

  document.getElementById('adminButtons').classList.toggle('hidden', !isAdmin);
  document.getElementById('studentButtons').classList.toggle('hidden', isAdmin);

  renderCenters(centers);
});

// –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
socket.on('authError', msg => {
  document.getElementById('loginError').textContent = msg;
});

// –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –≤—ã–±—Ä–∞–ª —Ç–µ–º—É ‚Äî –≤—Å–µ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
socket.on('topicsUpdate', centers => {
  lastCenters = centers;
  renderCenters(centers);
});

// –û—à–∏–±–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–º—É –∫–ª–∏–µ–Ω—Ç—É)
socket.on('topicError', msg => alert(msg));

function renderCenters(centers){
  const lang = currentLang;
  const container = document.getElementById('centersContainer');
  container.innerHTML = '';

  // –ù–∞–π–¥—ë–º, –≤—ã–±—Ä–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç —Ç–µ–º—É
  let myTopic = null, myCenter = null;
  centers.forEach(center=>{
    center.topics.forEach(topic=>{
      if(topic.student === currentFio){
        myTopic = topic;
        myCenter = center;
      }
    });
  });

  // –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –∏ —É–∂–µ –≤—ã–±—Ä–∞–ª —Ç–µ–º—É ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ –≤—ã–±–æ—Ä
  if(!isAdmin && myTopic){
    document.getElementById('myChoice').classList.remove('hidden');
    document.getElementById('centersTitle').classList.add('hidden');
    container.classList.add('hidden');
    document.getElementById('myChoice').textContent = `‚úÖ ${lang==='kk'?'–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑':'–í—ã –≤—ã–±—Ä–∞–ª–∏'}: ${myTopic.title[lang]} (${myCenter.name[lang]}) ‚Äî ${myTopic.time}`;
    return;
  } else {
    document.getElementById('myChoice').classList.add('hidden');
    document.getElementById('centersTitle').classList.remove('hidden');
    container.classList.remove('hidden');
  }

  centers.forEach(center=>{
    const block = document.createElement('div');
    block.className = 'center-block';

    const header = document.createElement('div');
    header.className = 'center-header';
    header.textContent = center.name[lang];
    header.onclick = () => {
      const t = block.querySelector('.topics');
      t.style.display = (t.style.display === 'none') ? 'block' : 'none';
    };
    block.appendChild(header);

    const topicsDiv = document.createElement('div');
    topicsDiv.className = 'topics';
    topicsDiv.style.display = isAdmin ? 'block' : 'none';

    center.topics.forEach(topic=>{
      const d = document.createElement('div');
      d.className = 'topic ' + (topic.student ? 'taken' : 'free');
      // –ï—Å–ª–∏ —Ç–µ–º–∞ –∑–∞–Ω—è—Ç–∞ –∫–µ–º-—Ç–æ:
      if(topic.student){
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ç–æ –∑–∞–Ω—è–ª (–Ω–æ –Ω–µ –º–µ–Ω—è–µ–º currentFio)
        d.textContent = `${topic.id}. ${topic.title[lang]} ‚Äî ${topic.student} (${topic.time})`;
      } else {
        // –°–≤–æ–±–æ–¥–Ω–∞—è —Ç–µ–º–∞
        d.textContent = `${topic.id}. ${topic.title[lang]}`;
        // –¢–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç, –∞ –Ω–µ –∞–¥–º–∏–Ω, –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å (–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª –Ω–∏—á–µ–≥–æ)
        if(!isAdmin){
          d.style.cursor = 'pointer';
          d.onclick = () => {
            if(confirm(`${lang==='kk' ? '–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑ –±–∞' : '–í—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ'}: "${topic.title[lang]}" ?`)){
              // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º–µ–Ω–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ (—á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –º–æ–≥ –Ω–∞–π—Ç–∏ —Ü–µ–Ω—Ç—Ä)
              socket.emit('chooseTopic', {
                fio: currentFio,
                centerName: center.name[lang],
                topicId: topic.id
              });
            }
          };
        }
      }
      topicsDiv.appendChild(d);
    });

    block.appendChild(topicsDiv);
    container.appendChild(block);
  });
}

// UI actions
function logout(){ location.reload(); }
function downloadReport(){ window.location = '/downloadReport?lang=' + currentLang; }
function clearAll(){ if(confirm(currentLang==='kk' ? '‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ —Ç–∞“£–¥–∞–ª“ì–∞–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–∑–∞–ª–∞—É –∫–µ—Ä–µ–∫ –ø–µ?' : '‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–º—ã?')) socket.emit('clearAll'); }

// –ú–µ–Ω—è–µ–º —è–∑—ã–∫ –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
document.getElementById('langSelect').addEventListener('change', e=>{
  currentLang = e.target.value;
  renderCenters(lastCenters);
});
</script>
</body>
</html>
