<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8">
  <title>–°–æ—Ç —Ç”©—Ä–µ–ª—ñ–≥—ñ –∞–∫–∞–¥–µ–º–∏—è—Å—ã</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; font-size: 18px; }
    h1 { font-size: 32px; }
    h2 { font-size: 24px; margin-top: 30px; }
    li { margin-bottom: 12px; list-style: none; font-size: 18px; }
    li button { padding: 8px 12px; font-size: 18px; margin-right: 5px; border: none; cursor: pointer; border-radius: 4px; transition: background-color 0.3s, transform 0.2s; }
    li button:hover { transform: scale(1.05); }
    .my-selected { background-color: #4caf50; color: white; padding: 5px; border-radius: 4px; animation: highlight 0.5s ease-in-out; }
    @keyframes highlight { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    #centersList li { margin-bottom: 12px; }
    #centersList button { width: 100%; text-align: left; padding: 10px; font-size: 20px; border-radius: 6px; border: none; transition: transform 0.2s; }
    #centersList button:hover { transform: scale(1.03); }
    .center-available { background-color: #a5d6a7; color: #000; } /* –∑–µ–ª—ë–Ω—ã–π */
    .center-blocked { background-color: #eeeeee; color: #888; cursor: not-allowed; } /* —Å–µ—Ä—ã–π */
    .center-default { background-color: #90caf9; color: #000; } /* —Å–∏–Ω–∏–π */
    #loginDiv { margin-bottom: 20px; }
    #userStatus { font-size: 20px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>–°–æ—Ç —Ç”©—Ä–µ–ª—ñ–≥—ñ –∞–∫–∞–¥–µ–º–∏—è—Å—ã –º–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä—ã–Ω—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</h1>

  <div id="loginDiv">
    <label id="fioLabel">
      –¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑: 
      <input type="text" id="fio">
    </label>
    <button id="loginBtn" onclick="register()">–ö—ñ—Ä—É</button>
    <span id="userStatus" style="display:none;"></span>
    <button id="logoutBtn" onclick="logout()" style="display:none;">–®—ã“ì—É</button>
  </div>

  <div style="margin-top: 10px;">
    <button onclick="downloadReport()">üìÑ –ï—Å–µ–ø—Ç—ñ –∂“Ø–∫—Ç–µ—É</button>
  </div>

  <h2>–û—Ä—Ç–∞–ª—ã“õ—Ç–∞—Ä</h2>
  <ul id="centersList">
    <li><button id="btn-center1" onclick="showCenter('center1')" class="center-default">–ú–µ–º–ª–µ–∫–µ—Ç—Ç—ñ–∫-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</button></li>
    <li><button id="btn-center2" onclick="showCenter('center2')" class="center-default">–ê–∑–∞–º–∞—Ç—Ç—ã“õ-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</button></li>
    <li><button id="btn-center3" onclick="showCenter('center3')" class="center-default">“ö—ã–ª–º—ã—Å—Ç—ã“õ-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</button></li>
  </ul>

  <ul id="center1" style="display:none;"></ul>
  <ul id="center2" style="display:none;"></ul>
  <ul id="center3" style="display:none;"></ul>

  <script>
    const socket = io();
    let fio = "";
    let selectedCenter = null;

    function register() {
      fio = document.getElementById('fio').value.trim();
      if (!fio) { alert("–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!"); return; }

      socket.emit('registerStudent', fio);

      document.getElementById('fioLabel').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'none';

      const userStatus = document.getElementById('userStatus');
      userStatus.innerText = "–ö—ñ—Ä—É –∂–∞—Å–∞–ª–¥—ã: " + fio;
      userStatus.style.display = 'inline-block';
      document.getElementById('logoutBtn').style.display = 'inline-block';
    }

    function logout() {
      location.reload();
    }

    function showCenter(centerId) {
      if (selectedCenter) return;
      ['center1','center2','center3'].forEach(id => document.getElementById(id).style.display = 'none');
      document.getElementById(centerId).style.display = 'block';
    }

    function choose(centerName, topicId) {
      if (!fio) { alert("–ë—ñ—Ä—ñ–Ω—à—ñ —Ç–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!"); return; }

      const confirmChoice = confirm("–°—ñ–∑ –æ—Å—ã —Ç–∞“õ—ã—Ä—ã–ø—Ç—ã —Ç–∞“£–¥–∞—É“ì–∞ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?");
      if (!confirmChoice) return;

      socket.emit('chooseTopic', { fio, centerName, topicId });
    }

    function downloadReport() {
      window.location.href = "/downloadReport";
    }

    socket.on('topicsList', (centers) => {
      selectedCenter = null;

      // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—Ç—Ä, –≥–¥–µ –º–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç —É–∂–µ –≤—ã–±—Ä–∞–ª —Ç–µ–º—É
      centers.forEach(center => {
        if(center.topics.some(t => t.student === fio)) selectedCenter = center.name;
      });

      // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä
      if(selectedCenter) {
        if(selectedCenter === centers[0].name) document.getElementById('center1').style.display = 'block';
        else if(selectedCenter === centers[1].name) document.getElementById('center2').style.display = 'block';
        else if(selectedCenter === centers[2].name) document.getElementById('center3').style.display = 'block';
      }

      centers.forEach((center, idx) => {
        let html = "";
        const maxSelectable = 31;
        const selectedCount = center.topics.filter(t => t.student).length;
        const freeCount = Math.max(maxSelectable - selectedCount, 0);

        // –¶–≤–µ—Ç–æ–≤–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ü–µ–Ω—Ç—Ä–∞
        let btnId = 'btn-' + (idx === 0 ? 'center1' : idx === 1 ? 'center2' : 'center3');
        const btn = document.getElementById(btnId);
        if(selectedCenter && selectedCenter !== center.name || freeCount === 0) btn.className = 'center-blocked';
        else if(selectedCenter === null) btn.className = 'center-available';
        else btn.className = 'center-default';
        btn.innerText = `${center.name} ‚Äî –±–æ—Å –æ—Ä—ã–Ω–¥–∞—Ä: ${freeCount}`;
        btn.disabled = selectedCenter && selectedCenter !== center.name;

        // –°–ø–∏—Å–æ–∫ —Ç–µ–º
        center.topics.forEach(t => {
          let disabled = selectedCenter && selectedCenter !== center.name;
          if(selectedCount >= maxSelectable) disabled = true;

          let content = "";
          if(t.student === fio) content = `‚úÖ ${t.title} ‚Äî —Ç–∞“£–¥–∞–ª–¥—ã (${t.student}) (${t.time})`;
          else if(t.student) content = `‚ùå ${t.title} ‚Äî —Ç–∞“£–¥–∞–ª–¥—ã (${t.student}) (${t.time})`;
          else if(disabled) content = `üö´ –ë“±–ª –æ—Ä—Ç–∞–ª—ã“õ“õ–∞ —Å—ñ–∑–¥—ñ“£ —Ç–∞“£–¥–∞—É—ã“£—ã–∑ –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å`;
          else content = `<button onclick="choose('${center.name}', ${t.id})">${t.title}</button>`;

          html += `<li>${content}</li>`;
        });

        if(idx === 0) document.getElementById('center1').innerHTML = html;
        else if(idx === 1) document.getElementById('center2').innerHTML = html;
        else if(idx === 2) document.getElementById('center3').innerHTML = html;
      });
    });

    socket.on('topicError', (msg) => alert(msg));
  </script>
</body>
</html>
