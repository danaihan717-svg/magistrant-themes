<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Выбор темы магистра</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Выбор темы магистранта</h1>

  <div id="login">
    <input id="fio" placeholder="ФИО">
    <input id="iin" placeholder="ИИН">
    <button onclick="login()">Войти</button>
  </div>

  <div id="topics" style="display:none;">
    <h2>Темы</h2>
    <div id="centers"></div>
    <button onclick="clearAll()" id="clearBtn" style="display:none;">Очистить все (для админа)</button>
    <button onclick="downloadReport()">Скачать CSV</button>
  </div>

  <script>
    const socket = io();
    let isAdmin = false;

    function login() {
      const fio = document.getElementById('fio').value;
      const iin = document.getElementById('iin').value;
      socket.emit('registerStudent', { fio, iin });
    }

    socket.on('authError', msg => alert(msg));

    socket.on('topicsList', (centers, admin) => {
      isAdmin = admin;
      document.getElementById('login').style.display = 'none';
      document.getElementById('topics').style.display = 'block';
      document.getElementById('clearBtn').style.display = admin ? 'block' : 'none';

      const container = document.getElementById('centers');
      container.innerHTML = '';
      centers.forEach(c => {
        const div = document.createElement('div');
        div.innerHTML = `<h3>${c.name.ru}</h3>`;
        c.topics.forEach(t => {
          const btn = document.createElement('button');
          btn.textContent = t.title.ru + (t.student ? ` (занято: ${t.student})` : '');
          btn.disabled = !!t.student;
          btn.onclick = () => socket.emit('chooseTopic', { fio: document.getElementById('fio').value, centerName: c.name.ru, topicId: t.id });
          div.appendChild(btn);
          div.appendChild(document.createElement('br'));
        });
        container.appendChild(div);
      });
    });

    socket.on('topicError', msg => alert(msg));

    function clearAll() { socket.emit('clearAll'); }
    function downloadReport() { window.location.href = '/downloadReport'; }
  </script>
</body>
</html>
