<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8">
  <title>–°–æ—Ç —Ç”©—Ä–µ–ª—ñ–≥—ñ –∞–∫–∞–¥–µ–º–∏—è—Å—ã</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    li {
      margin-bottom: 8px; /* –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ */
      list-style: none;
    }
    li button {
      padding: 5px 10px;
      margin-right: 5px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .free button { background-color: #c8e6c9; }        /* —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ç–µ–º */
    .taken { background-color: #ffcdd2; padding: 5px; border-radius: 4px; }   /* –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥—Ä—É–≥–∏–º–∏ */
    .blocked { background-color: #eeeeee; padding: 5px; border-radius: 4px; } /* —Å–µ—Ä—ã–π –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤ */
    .my-selected { background-color: #4caf50; color: white; padding: 5px; border-radius: 4px; } /* —è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π –¥–ª—è –≤–∞—à–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã */
  </style>
</head>
<body>
  <h1>–°–æ—Ç —Ç”©—Ä–µ–ª—ñ–≥—ñ –∞–∫–∞–¥–µ–º–∏—è—Å—ã –º–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä—ã–Ω—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</h1>

  <div>
    <label>–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑: <input type="text" id="fio"></label>
    <button onclick="register()">–ö—ñ—Ä—É</button>
  </div>

  <div style="margin-top: 10px;">
    <button onclick="downloadReport()">üìÑ –ï—Å–µ–ø—Ç—ñ –∂“Ø–∫—Ç–µ—É</button>
  </div>

  <h2 id="title1">–ú–µ–º–ª–µ–∫–µ—Ç—Ç—ñ–∫-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</h2>
  <ul id="center1"></ul>

  <h2 id="title2">–ê–∑–∞–º–∞—Ç—Ç—ã“õ-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</h2>
  <ul id="center2"></ul>

  <h2 id="title3">“ö—ã–ª–º—ã—Å—Ç—ã“õ-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</h2>
  <ul id="center3"></ul>

  <div id="status" style="margin-top: 20px;"></div>

  <script>
    const socket = io();
    let fio = "";
    let selectedCenter = null;

    function register() {
      fio = document.getElementById('fio').value.trim();
      if (!fio) { alert("–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!"); return; }
      socket.emit('registerStudent', fio);
      document.getElementById('status').innerText = "‚úÖ –ö—ñ—Ä—É –∂–∞—Å–∞–ª–¥—ã: " + fio;
    }

    function choose(centerName, topicId) {
      if (!fio) { alert("–ë—ñ—Ä—ñ–Ω—à—ñ —Ç–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!"); return; }
      socket.emit('chooseTopic', { fio, centerName, topicId });
    }

    function downloadReport() {
      window.location.href = "/downloadReport";
    }

    socket.on('topicsList', (centers) => {
      selectedCenter = null;
      let mySelectedTopicId = null;

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä –∏ —Ç–µ–º—É —Å—Ç—É–¥–µ–Ω—Ç–æ–º
      centers.forEach(center => {
        center.topics.forEach(t => {
          if(t.student === fio) {
            selectedCenter = center.name;
            mySelectedTopicId = t.id;
          }
        });
      });

      centers.forEach((center, idx) => {
        let html = "";
        let selectedCount = center.topics.filter(t => t.student).length;
        let freeCount = center.maxStudents - selectedCount;

        center.topics.forEach(t => {
          let disabled = selectedCenter && selectedCenter !== center.name;
          let itemClass = "";

          if(t.student === fio) {
            itemClass = "my-selected"; // –≤–∞—à–∞ –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–µ–º–∞
          } else if(t.student) {
            itemClass = "taken";       // –≤—ã–±—Ä–∞–Ω–∞ –¥—Ä—É–≥–∏–º
          } else if(disabled) {
            itemClass = "blocked";     // –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
          } else {
            itemClass = "free";        // —Å–≤–æ–±–æ–¥–Ω–∞
          }

          let content = "";
          if(t.student === fio) {
            content = `‚úÖ ${t.title} ‚Äî —Ç–∞“£–¥–∞–ª–¥—ã (${t.student}) (${t.time})`;
          } else if(t.student) {
            content = `‚ùå ${t.title} ‚Äî —Ç–∞“£–¥–∞–ª–¥—ã (${t.student}) (${t.time})`;
          } else if(disabled) {
            content = `üö´ –ë“±–ª –æ—Ä—Ç–∞–ª—ã“õ“õ–∞ —Å—ñ–∑–¥—ñ“£ —Ç–∞“£–¥–∞—É—ã“£—ã–∑ –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å`;
          } else {
            content = `<button onclick="choose('${center.name}', ${t.id})">${t.title}</button>`;
          }

          html += `<li class="${itemClass}">${content}</li>`;
        });

        if(idx === 0) {
          document.getElementById('center1').innerHTML = html;
          document.getElementById('title1').innerText = `${center.name} ‚Äî –±–æ—Å –æ—Ä—ã–Ω–¥–∞—Ä: ${freeCount}`;
        } else if(idx === 1) {
          document.getElementById('center2').innerHTML = html;
          document.getElementById('title2').innerText = `${center.name} ‚Äî –±–æ—Å –æ—Ä—ã–Ω–¥–∞—Ä: ${freeCount}`;
        } else if(idx === 2) {
          document.getElementById('center3').innerHTML = html;
          document.getElementById('title3').innerText = `${center.name} ‚Äî –±–æ—Å –æ—Ä—ã–Ω–¥–∞—Ä: ${freeCount}`;
        }
      });
    });

    socket.on('topicError', (msg) => alert(msg));
  </script>
</body>
</html>
