<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É—ã</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { color: #2c3e50; }
    .hidden { display: none; }
    .error { color: red; }
    .form-box {
      background: white; padding: 20px; border-radius: 10px;
      width: 320px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input { width: 100%; padding: 8px; margin: 6px 0 12px; border: 1px solid #ccc; border-radius: 5px; }
    button {
      padding: 10px 15px; background: #007bff; color: white;
      border: none; border-radius: 5px; cursor: pointer; margin-top: 5px;
    }
    button:hover { background: #0056b3; }
    .center-block { margin-bottom: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .center-header { padding: 12px; background: #e9ecef; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
    .topics { display: none; padding: 10px; }
    .topic { margin: 5px 0; padding: 8px; border-radius: 5px; cursor: pointer; }
    .taken { background: #f8d7da; color: #721c24; }
    .free { background: #d4edda; color: #155724; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .my-choice { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    #langSelect { margin-bottom: 20px; padding: 5px; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>üéì –ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –∂“Ø–π–µ—Å—ñ</h1>

  <!-- –Ø–∑—ã–∫ -->
  <select id="langSelect">
    <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
  </select>

  <!-- –õ–æ–≥–∏–Ω —Ñ–æ—Ä–º–∞ -->
  <div id="loginForm" class="form-box">
    <label id="fioLabel">–§–ò–û:</label>
    <input type="text" id="fio" placeholder="–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
    <label id="iinLabel">–ò–ò–ù:</label>
    <input type="password" id="iin" placeholder="–ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
    <button onclick="login()" id="loginBtn">–ö—ñ—Ä—É</button>
    <p class="error" id="loginError"></p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="main" class="hidden">
    <div class="top-bar">
      <div>üë§ <b id="studentName"></b></div>
      <div id="adminButtons" class="hidden">
        <button onclick="downloadReport()">üì• –û—Ç—á—ë—Ç (CSV)</button>
        <button onclick="clearAll()">üßπ –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞–ª–∞—É</button>
        <button onclick="logout()">üö™ –®—ã“ì—É</button>
      </div>
      <div id="studentButtons" class="hidden">
        <button onclick="downloadReport()">üì• –û—Ç—á—ë—Ç (CSV)</button>
        <button onclick="logout()">üö™ –®—ã“ì—É</button>
      </div>
    </div>

    <div id="myChoice" class="my-choice hidden"></div>
    <h2 id="centersTitle">üìö –û—Ä—Ç–∞–ª—ã“õ—Ç–∞—Ä</h2>
    <div id="centers"></div>
  </div>

  <script>
    const socket = io();
    let currentFio = null;
    let currentLang = "kk";
    let centersData = [];

    document.getElementById("langSelect").addEventListener("change", e => {
      currentLang = e.target.value;
      renderCenters();
      updateLabels();
    });

    function updateLabels() {
      const labels = {
        kk: { fio: "–§–ò–û:", iin: "–ò–ò–ù:", login: "–ö—ñ—Ä—É" },
        ru: { fio: "–§–ò–û:", iin: "–ò–ò–ù:", login: "–í–æ–π—Ç–∏" }
      };
      const l = labels[currentLang];
      document.getElementById("fioLabel").textContent = l.fio;
      document.getElementById("iinLabel").textContent = l.iin;
      document.getElementById("loginBtn").textContent = l.login;
    }

    function login() {
      const fio = document.getElementById("fio").value.trim();
      const iin = document.getElementById("iin").value.trim();
      if (!fio || !iin) {
        document.getElementById("loginError").textContent = currentLang === "kk" ? "‚ö†Ô∏è –§–ò–û –∂”ô–Ω–µ –ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!" : "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –§–ò–û –∏ –ò–ò–ù!";
        return;
      }
      socket.emit("registerStudent", { fio, iin });
      currentFio = fio;
    }

    socket.on("authError", msg => { document.getElementById("loginError").textContent = msg; });

    socket.on("topicsList", (centers, isAdmin) => {
      centersData = centers;
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      document.getElementById("studentName").textContent = currentFio;

      if (isAdmin) {
        document.getElementById("adminButtons").classList.remove("hidden");
        document.getElementById("studentButtons").classList.add("hidden");
      } else {
        document.getElementById("adminButtons").classList.add("hidden");
        document.getElementById("studentButtons").classList.remove("hidden");
      }

      renderCenters();
    });

    function renderCenters() {
      const container = document.getElementById("centers");
      container.innerHTML = "";

      let myTopic = null, myCenter = null;

      // –∏—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
      centersData.forEach(center => {
        center.topics.forEach(topic => {
          if (topic.student === currentFio) { myTopic = topic; myCenter = center; }
        });
      });

      if (myTopic) {
        document.getElementById("myChoice").classList.remove("hidden");
        document.getElementById("centersTitle").classList.add("hidden");
        container.classList.add("hidden");
        document.getElementById("myChoice").textContent =
          (currentLang==="kk" ? "‚úÖ –°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑: " : "‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏: ") +
          `${myTopic.title[currentLang]} (${myCenter.name[currentLang]}) ‚Äî ${myTopic.time}`;
        return;
      }

      document.getElementById("myChoice").classList.add("hidden");
      document.getElementById("centersTitle").classList.remove("hidden");
      container.classList.remove("hidden");

      centersData.forEach(center => {
        const block = document.createElement("div");
        block.className = "center-block";
        const header = document.createElement("div");
        header.className = "center-header";
        header.textContent = center.name[currentLang];
        header.onclick = () => {
          const topicsDiv = block.querySelector(".topics");
          topicsDiv.style.display = (topicsDiv.style.display === "none") ? "block" : "none";
        };
        block.appendChild(header);

        const topicsDiv = document.createElement("div");
        topicsDiv.className = "topics";

        center.topics.forEach(topic => {
          const div = document.createElement("div");
          div.className = "topic " + (topic.student ? "taken" : "free");
          div.textContent = `${topic.id}. ${topic.title[currentLang]} ${topic.student ? " ‚Äî " + topic.student + " (" + topic.time + ")" : ""}`;
          if (!topic.student) {
            div.onclick = () => {
              if (confirm((currentLang==="kk" ? "–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑ –±–∞: " : "–í—ã –≤—ã–±—Ä–∞–ª–∏: ") + `"${topic.title[currentLang]}" ?`)) {
                socket.emit("chooseTopic", { fio: currentFio, centerName: center.name, topicId: topic.id });
              }
            };
          }
          topicsDiv.appendChild(div);
        });

        block.appendChild(topicsDiv);
        container.appendChild(block);
      });
    }

    socket.on("topicError", msg => { alert(msg); });

    function logout() { location.reload(); }
    function downloadReport() { window.location = "/downloadReport"; }
    function clearAll() { if (confirm(currentLang==="kk" ? "‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ —Ç–∞“£–¥–∞–ª“ì–∞–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–∑–∞–ª–∞—É –∫–µ—Ä–µ–∫ –ø–µ?" : "‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–º—ã?")) socket.emit("clearAll"); }
  </script>
</body>
</html>
