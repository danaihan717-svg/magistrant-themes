<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="utf-8" />
<title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa}
  h1{color:#2c3e50}
  .form-box{background:#fff;padding:16px;border-radius:8px;width:340px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  input,select,button{padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
  button{background:#007bff;color:#fff;border:none;cursor:pointer}
  button:hover{opacity:0.95}
  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
  .center-block{background:#fff;border-radius:8px;margin-top:10px;padding:0;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
  .center-header{padding:12px;background:#e9ecef;border-radius:8px 8px 0 0;font-weight:bold;cursor:pointer}
  .topics{padding:10px;display:none}
  .topic{padding:8px;border-radius:6px;margin-bottom:6px}
  .free{background:#e9f7ec;color:#155724;cursor:pointer}
  .taken{background:#f8d7da;color:#721c24;cursor:default}
  .my-choice{background:#fff8e1;border:1px solid #ffeeba;padding:12px;border-radius:8px;margin-top:12px}
  .hidden{display:none}
</style>
</head>
<body>
  <h1>üéì –ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –∂“Ø–π–µ—Å—ñ</h1>

  <div id="loginForm" class="form-box">
    <label>–ò–ò–ù:</label><br>
    <input id="iin" type="text" placeholder="–ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" /><br>
    <label>–¢—ñ–ª / –Ø–∑—ã–∫:</label><br>
    <select id="langSelect">
      <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select><br>
    <button onclick="login()">–ö—ñ—Ä—É / –í–æ–π—Ç–∏</button>
    <p id="loginError" style="color:red"></p>
  </div>

  <div id="main" class="hidden">
    <div class="top-bar">
      <div>üë§ <b id="studentName"></b></div>
      <div>
        <div id="adminButtons" class="hidden">
          <button onclick="downloadReport()">üì• –û—Ç—á—ë—Ç (CSV)</button>
          <button onclick="clearAll()">üßπ –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞–ª–∞—É</button>
          <button onclick="logout()">üö™ –®—ã“ì—É</button>
        </div>
        <div id="studentButtons" class="hidden">
          <button onclick="logout()">üö™ –®—ã“ì—É</button>
        </div>
      </div>
    </div>

    <div id="myChoice" class="my-choice hidden"></div>

    <h2 id="centersTitle">üìö –û—Ä—Ç–∞–ª—ã“õ—Ç–∞—Ä</h2>
    <div id="centersContainer"></div>
  </div>

<script>
const socket = io();
let currentFio = null;
let isAdmin = false;
let currentLang = 'kk';
let lastCenters = [];
let currentFioHasTopic = false;

// –í—Ö–æ–¥
function login(){
  const iin = document.getElementById('iin').value.trim();
  currentLang = document.getElementById('langSelect').value;
  if(!iin){ document.getElementById('loginError').textContent = '‚ö†Ô∏è –ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!'; return; }
  document.getElementById('loginError').textContent = '';
  socket.emit('registerStudent',{ iin, lang: currentLang });
}

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
socket.on('authSuccess', ({ fio, isAdmin: adminFlag, centers, lang }) => {
  currentFio = fio;
  isAdmin = adminFlag;
  currentLang = lang || currentLang;
  lastCenters = centers;

  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  document.getElementById('studentName').textContent = currentFio;

  document.getElementById('adminButtons').classList.toggle('hidden', !isAdmin);
  document.getElementById('studentButtons').classList.toggle('hidden', isAdmin);

  renderCenters(centers);
});

// –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
socket.on('authError', msg => {
  document.getElementById('loginError').textContent = msg;
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–µ–º
socket.on('topicsUpdate', updatedCenters => {
  lastCenters = updatedCenters;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π —Å—Ç—É–¥–µ–Ω—Ç —Ç–µ–º—É
  currentFioHasTopic = false;
  updatedCenters.forEach(center => {
    center.topics.forEach(topic => {
      if(topic.student === currentFio) currentFioHasTopic = true;
    });
  });

  updatedCenters.forEach(center => {
    center.topics.forEach(topic => {
      const topicId = `topic-${center.name.kk}-${topic.id}`;
      let topicDiv = document.getElementById(topicId);

      if(topicDiv){
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–º—É
        if(topic.student){
          topicDiv.className = 'topic taken';
          topicDiv.textContent = `${topic.id}. ${topic.title[currentLang]} ‚Äî ${topic.student} (${topic.time})`;
          topicDiv.onclick = null;
        } else {
          topicDiv.className = 'topic free';
          topicDiv.textContent = `${topic.id}. ${topic.title[currentLang]}`;
          if(!isAdmin && !currentFioHasTopic){
            topicDiv.style.cursor = 'pointer';
            topicDiv.onclick = () => chooseTopic(center, topic);
          }
        }
      }
    });
  });

  renderMyChoice();
});

// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä —Å—Ç—É–¥–µ–Ω—Ç–∞
function renderMyChoice(){
  let myTopic = null, myCenter = null;
  lastCenters.forEach(center => {
    center.topics.forEach(topic => {
      if(topic.student === currentFio){
        myTopic = topic;
        myCenter = center;
      }
    });
  });

  if(myTopic){
    document.getElementById('myChoice').classList.remove('hidden');
    document.getElementById('centersTitle').classList.add('hidden');
    document.getElementById('centersContainer').classList.add('hidden');
    document.getElementById('myChoice').textContent = `‚úÖ ${currentLang==='kk'?'–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑':'–í—ã –≤—ã–±—Ä–∞–ª–∏'}: ${myTopic.title[currentLang]} (${myCenter.name[currentLang]}) ‚Äî ${myTopic.time}`;
  } else {
    document.getElementById('myChoice').classList.add('hidden');
    document.getElementById('centersTitle').classList.remove('hidden');
    document.getElementById('centersContainer').classList.remove('hidden');
  }
}

// –ü–æ–ª–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ü–µ–Ω—Ç—Ä–æ–≤ –∏ —Ç–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
function renderCenters(centers){
  const container = document.getElementById('centersContainer');
  container.innerHTML = '';

  centers.forEach(center => {
    const block = document.createElement('div');
    block.className = 'center-block';

    const header = document.createElement('div');
    header.className = 'center-header';
    header.textContent = center.name[currentLang];
    header.onclick = () => {
      const t = block.querySelector('.topics');
      t.style.display = (t.style.display === 'none') ? 'block' : 'none';
    };
    block.appendChild(header);

    const topicsDiv = document.createElement('div');
    topicsDiv.className = 'topics';
    topicsDiv.style.display = isAdmin ? 'block' : 'none';

    center.topics.forEach(topic => {
      const topicDiv = document.createElement('div');
      topicDiv.id = `topic-${center.name.kk}-${topic.id}`;
      topicDiv.className = topic.student ? 'topic taken' : 'topic free';
      topicDiv.textContent = topic.student ? `${topic.id}. ${topic.title[currentLang]} ‚Äî ${topic.student} (${topic.time})` : `${topic.id}. ${topic.title[currentLang]}`;

      if(!isAdmin && !currentFioHasTopic && !topic.student){
        topicDiv.style.cursor = 'pointer';
        topicDiv.onclick = () => chooseTopic(center, topic);
      }

      topicsDiv.appendChild(topicDiv);
    });

    block.appendChild(topicsDiv);
    container.appendChild(block);
  });

  renderMyChoice();
}

// UI actions
function chooseTopic(center, topic){
  if(confirm(`${currentLang==='kk'?'–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑ –±–∞':'–í—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ'}: "${topic.title[currentLang]}" ?`)){
    socket.emit('chooseTopic', {
      fio: currentFio,
      centerName: center.name[currentLang],
      topicId: topic.id
    });
  }
}

function logout(){ location.reload(); }
function downloadReport(){ window.location = '/downloadReport?lang=' + currentLang; }
function clearAll(){ 
  if(confirm(currentLang==='kk' ? '‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ —Ç–∞“£–¥–∞–ª“ì–∞–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–∑–∞–ª–∞—É –∫–µ—Ä–µ–∫ –ø–µ?' : '‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–º—ã?')) 
    socket.emit('clearAll'); 
}

// –ú–µ–Ω—è–µ–º —è–∑—ã–∫ –ª–æ–∫–∞–ª—å–Ω–æ
document.getElementById('langSelect').addEventListener('change', e=>{
  currentLang = e.target.value;
  renderCenters(lastCenters);
});
</script>
</body>
</html>
