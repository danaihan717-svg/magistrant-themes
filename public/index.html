<!DOCTYPE html>
<html lang="kz">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É—ã</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>–¢–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É</h1>

  <div>
    <label>–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑: <input type="text" id="fio"></label>
    <button onclick="register()">–ö—ñ—Ä—É</button>
  </div>

  <div style="margin-top: 10px;">
    <button onclick="downloadReport()">üìÑ –ï—Å–µ–ø—Ç—ñ –∂“Ø–∫—Ç–µ—É</button>
  </div>

  <h2>–ú–µ–º–ª–µ–∫–µ—Ç—Ç—ñ–∫-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</h2>
  <ul id="center1"></ul>

  <h2>–ê–∑–∞–º–∞—Ç—Ç—ã“õ-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</h2>
  <ul id="center2"></ul>

  <h2>“ö—ã–ª–º—ã—Å—Ç—ã“õ-“õ“±“õ—ã“õ—Ç—ã“õ –ø”ô–Ω–¥–µ—Ä–¥—ñ“£ “ì—ã–ª—ã–º–∏-–±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã</h2>
  <ul id="center3"></ul>

  <div id="status" style="margin-top: 20px;"></div>

  <script>
    const socket = io();
    let fio = "";
    let selectedCenter = null;

    function register() {
      fio = document.getElementById('fio').value.trim();
      if (!fio) {
        alert("–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!");
        return;
      }
      socket.emit('registerStudent', fio);
      document.getElementById('status').innerText = "‚úÖ –ö—ñ—Ä—É –∂–∞—Å–∞–ª–¥—ã: " + fio;
    }

    function choose(centerName, topicId) {
      if (!fio) {
        alert("–ë—ñ—Ä—ñ–Ω—à—ñ —Ç–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!");
        return;
      }
      socket.emit('chooseTopic', { fio, centerName, topicId });
    }

    function downloadReport() {
      window.location.href = "/downloadReport";
    }

    socket.on('topicsList', (centers) => {
      let html1 = "", html2 = "", html3 = "";
      let blockedCenter = selectedCenter; // —Ü–µ–Ω—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–ª —Å—Ç—É–¥–µ–Ω—Ç

      centers.forEach(center => {
        center.topics.forEach(t => {
          let disabled = blockedCenter && blockedCenter !== center.name;
          let item = t.student 
            ? `‚ùå ${t.title} ‚Äî —Ç–∞“£–¥–∞–ª–¥—ã (${t.student}) (${t.time})` 
            : disabled 
              ? `üö´ –ë“±–ª –æ—Ä—Ç–∞–ª—ã“õ“õ–∞ —Å—ñ–∑–¥—ñ“£ —Ç–∞“£–¥–∞—É—ã“£—ã–∑ –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å` 
              : `<button onclick="choose('${center.name}', ${t.id})">${t.title}</button>`;

          if(center.name.includes("–ú–µ–º–ª–µ–∫–µ—Ç—Ç—ñ–∫")) html1 += `<li>${item}</li>`;
          else if(center.name.includes("–ê–∑–∞–º–∞—Ç—Ç—ã“õ")) html2 += `<li>${item}</li>`;
          else if(center.name.includes("“ö—ã–ª–º—ã—Å—Ç—ã“õ")) html3 += `<li>${item}</li>`;
        });
      });

      document.getElementById('center1').innerHTML = html1;
      document.getElementById('center2').innerHTML = html2;
      document.getElementById('center3').innerHTML = html3;

      // –û–±–Ω–æ–≤–ª—è–µ–º selectedCenter, –µ—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –≤—ã–±—Ä–∞–ª —Ç–µ–º—É
      centers.forEach(center => {
        let hasStudent = center.topics.some(t => t.student === fio);
        if(hasStudent) selectedCenter = center.name;
      });
    });

    socket.on('topicError', (msg) => alert(msg));
  </script>
</body>
</html>
