<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="UTF-8">
<title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial; margin:20px; background:#f8f9fa; }
h1{color:#2c3e50;} .hidden{display:none;} .error{color:red;}
.form-box{background:white;padding:20px;border-radius:10px;width:320px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
input{width:100%;padding:8px;margin:6px 0 12px;border:1px solid #ccc;border-radius:5px;}
button{padding:10px 15px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;margin-top:5px;}
button:hover{background:#0056b3;}
.center-block{margin-bottom:10px;background:white;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.center-header{padding:12px;background:#e9ecef;cursor:pointer;border-radius:8px 8px 0 0;font-weight:bold;}
.topics{display:none;padding:10px;}
.topic{margin:5px 0;padding:8px;border-radius:5px;cursor:pointer;}
.taken{background:#f8d7da;color:#721c24;}
.free{background:#d4edda;color:#155724;}
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.my-choice{background:#fff3cd;border:1px solid #ffeeba;padding:15px;border-radius:10px;margin-bottom:20px;}
</style>
</head>
<body>
<h1>üéì –ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É</h1>

<div id="loginForm" class="form-box">
<label>–ò–ò–ù:</label>
<input type="password" id="iin" placeholder="–ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
<button onclick="login()">–ö—ñ—Ä—É</button>
<p class="error" id="loginError"></p>
</div>

<div id="main" class="hidden">
<div class="top-bar">
<div>üë§ <b id="studentName"></b></div>
<div id="adminButtons" class="hidden">
<button onclick="downloadReport()">üì• –û—Ç—á—ë—Ç (CSV)</button>
<button onclick="clearAll()">üßπ –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞–ª–∞—É</button>
<button onclick="logout()">üö™ –®—ã“ì—É</button>
</div>
<div id="studentButtons" class="hidden">
<button onclick="logout()">üö™ –®—ã“ì—É</button>
</div>
</div>

<div id="myChoice" class="my-choice hidden"></div>
<h2 id="centersTitle">üìö –û—Ä—Ç–∞–ª—ã“õ—Ç–∞—Ä</h2>
<div id="centers"></div>

<script>
const socket = io(); let currentFio = null; let isAdmin = false;

function login(){
  const iin = document.getElementById("iin").value.trim();
  if(!iin){document.getElementById("loginError").textContent="‚ö†Ô∏è –ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!"; return;}
  socket.emit("registerStudent",{ iin });
}

socket.on("authError", msg => document.getElementById("loginError").textContent=msg);

socket.on("topicsList",(centersList, admin, fio)=>{
  isAdmin=admin; currentFio=fio;
  document.getElementById("loginForm").classList.add("hidden");
  document.getElementById("main").classList.remove("hidden");
  document.getElementById("studentName").textContent=fio;

  document.getElementById("adminButtons").classList.toggle("hidden", !admin);
  document.getElementById("studentButtons").classList.toggle("hidden", admin);

  const container = document.getElementById("centers");
  container.innerHTML=""; let myTopic=null, myCenter=null;

  if(!admin){
    centersList.forEach(c=>{
      c.topics.forEach(t=>{ if(t.student===fio){myTopic=t; myCenter=c;} });
    });
    if(myTopic){
      document.getElementById("myChoice").classList.remove("hidden");
      container.classList.add("hidden"); document.getElementById("centersTitle").classList.add("hidden");
      document.getElementById("myChoice").textContent=`‚úÖ –°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑: ${myTopic.title.kk} (${myCenter.name.kk}) ‚Äî ${myTopic.time}`;
      return;
    }
    document.getElementById("myChoice").classList.add("hidden"); container.classList.remove("hidden");
    document.getElementById("centersTitle").classList.remove("hidden");
  }

  centersList.forEach(center=>{
    const block=document.createElement("div"); block.className="center-block";
    const header=document.createElement("div"); header.className="center-header"; header.textContent=center.name.kk;
    header.onclick=()=>{const tDiv=block.querySelector(".topics"); tDiv.style.display=tDiv.style.display==="none"?"block":"none";};
    block.appendChild(header);

    const topicsDiv=document.createElement("div"); topicsDiv.className="topics";
    if(admin) topicsDiv.style.display="block";

    center.topics.forEach(topic=>{
      const div=document.createElement("div");
      div.className="topic "+(topic.student?"taken":"free");
      div.textContent=`${topic.id}. ${topic.title.kk} ${topic.student?" ‚Äî "+topic.student+" ("+topic.time+")":""}`;

      if(!topic.student && !admin){
        div.onclick=()=>{if(confirm(`–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑ –±–∞: "${topic.title.kk}" ?`)){
          socket.emit("chooseTopic",{ fio:currentFio, centerName:center.name.kk, topicId:topic.id }); }};
      }
      topicsDiv.appendChild(div);
    });
    block.appendChild(topicsDiv); container.appendChild(block);
  });
});

function logout(){ location.reload(); }
function downloadReport(){ window.location="/downloadReport"; }
function clearAll(){ if(confirm("‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ —Ç–∞“£–¥–∞–ª“ì–∞–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–∑–∞–ª–∞—É –∫–µ—Ä–µ–∫ –ø–µ?")) socket.emit("clearAll"); }
</script>
</body>
</html>
