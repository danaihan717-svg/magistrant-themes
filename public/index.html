<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É—ã</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { color: #2c3e50; }
    .hidden { display: none; }
    .error { color: red; }
    .form-box {
      background: white; padding: 20px; border-radius: 10px;
      width: 320px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input { width: 100%; padding: 8px; margin: 6px 0 12px; border: 1px solid #ccc; border-radius: 5px; }
    button {
      padding: 10px 15px; background: #007bff; color: white;
      border: none; border-radius: 5px; cursor: pointer; margin-top: 5px;
    }
    button:hover { background: #0056b3; }
    .center-block { margin-bottom: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .center-header { padding: 12px; background: #e9ecef; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
    .topics { display: none; padding: 10px; }
    .topic { margin: 5px 0; padding: 8px; border-radius: 5px; cursor: pointer; }
    .taken { background: #f8d7da; color: #721c24; }
    .free { background: #d4edda; color: #155724; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .my-choice { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .lang-switch { margin-left: 10px; padding: 5px 10px; cursor: pointer; border-radius: 5px; border: 1px solid #007bff; background: white; color: #007bff; }
    .lang-switch.active { background: #007bff; color: white; }
  </style>
</head>
<body>
  <h1>üéì –ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä–¥—ã“£ —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –∂“Ø–π–µ—Å—ñ</h1>

  <!-- –Ø–∑—ã–∫ -->
  <div style="margin-bottom: 15px;">
    <span>–¢—ñ–ª / –Ø–∑—ã–∫:</span>
    <span class="lang-switch active" id="kkBtn">KK</span>
    <span class="lang-switch" id="ruBtn">RU</span>
  </div>

  <!-- –õ–æ–≥–∏–Ω —Ñ–æ—Ä–º–∞ -->
  <div id="loginForm" class="form-box">
    <label id="fioLabel">–§–ò–û:</label>
    <input type="text" id="fio" placeholder="–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
    <label id="iinLabel">–ò–ò–ù:</label>
    <input type="password" id="iin" placeholder="–ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
    <button id="loginBtn" onclick="login()">–ö—ñ—Ä—É</button>
    <p class="error" id="loginError"></p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="main" class="hidden">
    <div class="top-bar">
      <div>üë§ <b id="studentName"></b></div>
      <div id="adminButtons" class="hidden">
        <button onclick="downloadReport()" id="csvBtn">üì• –û—Ç—á—ë—Ç (CSV)</button>
        <button onclick="clearAll()" id="clearBtn">üßπ –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞–ª–∞—É</button>
        <button onclick="logout()" id="logoutBtn">üö™ –®—ã“ì—É</button>
      </div>
      <div id="studentButtons" class="hidden">
        <button onclick="downloadReport()" id="csvBtn2">üì• –û—Ç—á—ë—Ç (CSV)</button>
        <button onclick="logout()" id="logoutBtn2">üö™ –®—ã“ì—É</button>
      </div>
    </div>

    <div id="myChoice" class="my-choice hidden"></div>
    <h2 id="centersTitle">üìö –û—Ä—Ç–∞–ª—ã“õ—Ç–∞—Ä</h2>
    <div id="centers"></div>
  </div>

  <script>
    const socket = io();
    let currentFio = null;
    let lang = 'kk'; // —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
    const kkBtn = document.getElementById('kkBtn');
    const ruBtn = document.getElementById('ruBtn');
    kkBtn.onclick = () => { setLang('kk'); };
    ruBtn.onclick = () => { setLang('ru'); };
    function setLang(l) {
      lang = l;
      if(lang==='kk'){ kkBtn.classList.add('active'); ruBtn.classList.remove('active'); }
      else{ ruBtn.classList.add('active'); kkBtn.classList.remove('active'); }
      if(document.getElementById('main').classList.contains('hidden')===false){
        renderCenters(currentCenters, currentIsAdmin);
      }
    }

    // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
    const loginLabels = {
      kk: { fio: "–§–ò–û:", iin: "–ò–ò–ù:", loginBtn: "–ö—ñ—Ä—É", errorPlaceholder: "‚ö†Ô∏è –§–ò–û –∂”ô–Ω–µ –ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!" },
      ru: { fio: "–§–ò–û:", iin: "–ò–ò–ù:", loginBtn: "–í—Ö–æ–¥", errorPlaceholder: "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –§–ò–û –∏ –ò–ò–ù!" }
    };

    function updateLoginTexts(){
      document.getElementById('fioLabel').textContent = loginLabels[lang].fio;
      document.getElementById('iinLabel').textContent = loginLabels[lang].iin;
      document.getElementById('loginBtn').textContent = loginLabels[lang].loginBtn;
    }

    updateLoginTexts();

    function login() {
      updateLoginTexts();
      const fio = document.getElementById("fio").value.trim();
      const iin = document.getElementById("iin").value.trim();
      if (!fio || !iin) {
        document.getElementById("loginError").textContent = loginLabels[lang].errorPlaceholder;
        return;
      }
      socket.emit("registerStudent", { fio, iin });
      currentFio = fio;
    }

    let currentCenters = [];
    let currentIsAdmin = false;

    socket.on("authError", msg => { document.getElementById("loginError").textContent = msg; });

    socket.on("topicsList", (centers, isAdmin) => {
      currentCenters = centers;
      currentIsAdmin = isAdmin;
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      document.getElementById("studentName").textContent = currentFio;

      renderCenters(centers, isAdmin);
    });

    function renderCenters(centers, isAdmin){
      const container = document.getElementById("centers");
      container.innerHTML = "";
      let myTopic = null, myCenter = null;

      if(isAdmin){
        document.getElementById("adminButtons").classList.remove("hidden");
        document.getElementById("studentButtons").classList.add("hidden");
        document.getElementById("myChoice").classList.add("hidden");
        document.getElementById("centersTitle").classList.remove("hidden");
        container.classList.remove("hidden");

        centers.forEach(center => {
          const block = document.createElement("div");
          block.className = "center-block";
          const header = document.createElement("div");
          header.className = "center-header";
          header.textContent = center.name[lang];
          block.appendChild(header);
          const topicsDiv = document.createElement("div");
          topicsDiv.className = "topics";
          topicsDiv.style.display = "block";
          center.topics.forEach(topic => {
            const div = document.createElement("div");
            div.className = "topic " + (topic.student ? "taken" : "free");
            div.textContent = `${topic.id}. ${topic.title[lang]}${topic.student ? " ‚Äî " + topic.student + " (" + topic.time + ")" : ""}`;
            topicsDiv.appendChild(div);
          });
          block.appendChild(topicsDiv);
          container.appendChild(block);
        });
        return;
      }

      // —Å—Ç—É–¥–µ–Ω—Ç
      centers.forEach(center => {
        center.topics.forEach(topic => {
          if(topic.student===currentFio){ myTopic=topic; myCenter=center; }
        });
      });

      if(myTopic){
        document.getElementById("myChoice").classList.remove("hidden");
        document.getElementById("centersTitle").classList.add("hidden");
        container.classList.add("hidden");
        document.getElementById("myChoice").textContent = `‚úÖ ${lang==='kk'? '–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑' : '–í—ã –≤—ã–±—Ä–∞–ª–∏'}: ${myTopic.title[lang]} (${myCenter.name[lang]}) ‚Äî ${myTopic.time}`;
        return;
      }

      document.getElementById("myChoice").classList.add("hidden");
      document.getElementById("centersTitle").classList.remove("hidden");
      container.classList.remove("hidden");

      centers.forEach(center => {
        const block = document.createElement("div");
        block.className = "center-block";
        const header = document.createElement("div");
        header.className = "center-header";
        header.textContent = center.name[lang];
        header.onclick = () => {
          const topicsDiv = block.querySelector(".topics");
          topicsDiv.style.display = (topicsDiv.style.display==="none") ? "block" : "none";
        };
        block.appendChild(header);

        const topicsDiv = document.createElement("div");
        topicsDiv.className = "topics";
        center.topics.forEach(topic => {
          const div = document.createElement("div");
          div.className = "topic " + (topic.student ? "taken" : "free");
          div.textContent = `${topic.id}. ${topic.title[lang]}${topic.student ? " ‚Äî " + topic.student + " (" + topic.time + ")" : ""}`;
          if(!topic.student){
            div.onclick = () => {
              if(confirm(`${lang==='kk'? '–°—ñ–∑ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑ –±–∞' : '–í—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ'}: "${topic.title[lang]}" ?`)){
                socket.emit("chooseTopic", { fio: currentFio, centerName: center.name.kk, topicId: topic.id });
              }
            };
          }
          topicsDiv.appendChild(div);
        });
        block.appendChild(topicsDiv);
        container.appendChild(block);
      });
    }

    socket.on("topicError", msg => { alert(msg); });

    function logout() { location.reload(); }
    function downloadReport() { window.location = "/downloadReport"; }
    function clearAll() { if(confirm(lang==='kk'? "‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ —Ç–∞“£–¥–∞–ª“ì–∞–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–∑–∞–ª–∞—É –∫–µ—Ä–µ–∫ –ø–µ?" : "‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–º—ã?")) socket.emit("clearAll"); }
  </script>
</body>
</html>
