<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="UTF-8">
<title>Магистранттардың тақырып таңдауы</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* Стили оставляем те же */
</style>
</head>
<body>

<h1>🎓 Магистранттардың тақырып таңдау жүйесі</h1>

<div id="loginForm" class="form-box">
<label>ИИН:</label>
<input type="password" id="iin" placeholder="ИИН енгізіңіз">
<button onclick="login()">Кіру</button>
<p class="error" id="loginError"></p>
</div>

<div id="main" class="hidden">
<div class="top-bar">
<div>👤 <b id="studentName"></b></div>
<div>
<select id="langSelect" onchange="changeLang()">
<option value="kk">Қазақша</option>
<option value="ru">Русский</option>
</select>
</div>
<div id="adminButtons" class="hidden">
<button onclick="downloadReport()">📥 Отчёт (CSV)</button>
<button onclick="clearAll()">🧹 Барлығын тазалау</button>
<button onclick="logout()">🚪 Шығу</button>
</div>
<div id="studentButtons" class="hidden">
<button onclick="logout()">🚪 Шығу</button>
</div>
</div>

<div id="myChoice" class="my-choice hidden"></div>
<h2 id="centersTitle">📚 Орталықтар</h2>
<div id="centers"></div>

<script>
const socket = io();
let currentFio=null;
let currentLang="kk";
let currentCenters=[]; 
let isAdmin=false;

function login(){
    const iin = document.getElementById("iin").value.trim();
    if(!iin){ document.getElementById("loginError").textContent="⚠️ ИИН енгізіңіз!"; return; }
    socket.emit("registerStudent",{iin});
}

socket.on("authError", msg => document.getElementById("loginError").textContent=msg);

socket.on("topicsList",(centers, admin, fio)=>{
    currentFio=fio; isAdmin=admin; currentCenters=centers;
    document.getElementById("studentName").textContent=fio;
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");

    if(admin){ document.getElementById("adminButtons").classList.remove("hidden"); document.getElementById("studentButtons").classList.add("hidden"); }
    else { document.getElementById("adminButtons").classList.add("hidden"); document.getElementById("studentButtons").classList.remove("hidden"); }

    renderCenters();
});

function changeLang(){
    currentLang=document.getElementById("langSelect").value;
    renderCenters();
}

function renderCenters(){
    const container=document.getElementById("centers");
    container.innerHTML="";
    let myTopic=null, myCenter=null;

    currentCenters.forEach(center=>{
        center.topics.forEach(topic=>{
            if(topic.student===currentFio){ myTopic=topic; myCenter=center; }
        });
    });

    if(!isAdmin && myTopic){
        document.getElementById("myChoice").classList.remove("hidden");
        document.getElementById("centersTitle").classList.add("hidden");
        container.classList.add("hidden");
        document.getElementById("myChoice").textContent=`✅ Сіз таңдадыңыз: ${myTopic.title[currentLang]} (${myCenter.name[currentLang]}) — ${myTopic.time}`;
        return;
    }

    document.getElementById("myChoice").classList.add("hidden");
    document.getElementById("centersTitle").classList.remove("hidden");
    container.classList.remove("hidden");

    currentCenters.forEach(center=>{
        const block=document.createElement("div"); block.className="center-block";
        const header=document.createElement("div"); header.className="center-header"; header.textContent=center.name[currentLang];
        header.onclick=()=>{ const topicsDiv = block.querySelector(".topics"); topicsDiv.style.display = topicsDiv.style.display==="none"?"block":"none"; }
        block.appendChild(header);

        const topicsDiv=document.createElement("div"); topicsDiv.className="topics";

        center.topics.forEach(topic=>{
            const div=document.createElement("div");
            div.className="topic "+(topic.student?"taken":"free");
            div.textContent=`${topic.id}. ${topic.title[currentLang]} ${topic.student?" — "+topic.student+" ("+topic.time+")":""}`;

            if(!topic.student && !isAdmin){
                div.onclick=()=>{ if(confirm(`Сіз таңдадыңыз ба: "${topic.title[currentLang]}" ?`)){ socket.emit("chooseTopic",{fio:currentFio, centerName:center.name.kk, topicId:topic.id}); } }
            }
            topicsDiv.appendChild(div);
        });

        block.appendChild(topicsDiv);
        container.appendChild(block);
    });
}

socket.on("topicError", msg=>alert(msg));

function logout(){ location.reload(); }
function downloadReport(){ window.location="/downloadReport"; }
function clearAll(){ if(confirm("⚠️ Барлық таңдалған тақырыптарды тазалау керек пе?")) socket.emit("clearAll"); }

</script>
</body>
</html>
