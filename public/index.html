<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç—Ç–∞—Ä —Ç–∞“õ—ã—Ä—ã–ø —Ç–∞“£–¥–∞—É –∂“Ø–π–µ—Å—ñ</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .topic { border: 1px solid #ccc; margin: 5px; padding: 10px; border-radius: 5px; }
    .taken { background: #ffd6d6; }
    .lang-switch { margin-bottom: 10px; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
  <div class="lang-switch">
    <label>üåê –¢—ñ–ª / –Ø–∑—ã–∫: </label>
    <select id="lang">
      <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select>
  </div>

  <div id="login">
    <h3 id="loginTitle">–ò–ò–ù –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ / –í–≤–µ–¥–∏—Ç–µ –ò–ò–ù</h3>
    <input type="text" id="iinInput" placeholder="–ò–ò–ù">
    <button onclick="login()">–ö—ñ—Ä—É / –í–æ–π—Ç–∏</button>
    <p id="error" style="color:red"></p>
  </div>

  <div id="main" class="hidden">
    <h3 id="welcome"></h3>
    <div id="centers"></div>
    <button id="logoutBtn" onclick="logout()">üö™ –®—ã“ì—É</button>
    <button id="clearBtn" class="hidden" onclick="clearAll()">üßπ –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞–ª–∞—É</button>
    <button id="reportBtn" class="hidden" onclick="downloadReport()">üì• –ï—Å–µ–ø –∂“Ø–∫—Ç–µ—É</button>
  </div>

  <script>
    const socket = io();
    let currentLang = "kk";
    let isAdmin = false;

    document.getElementById("lang").addEventListener("change", (e) => {
      currentLang = e.target.value;
      renderCenters(window.centers || []);
    });

    function login() {
      const iin = document.getElementById("iinInput").value.trim();
      socket.emit("registerStudent", { iin });
    }

    function logout() {
      location.reload();
    }

    socket.on("authError", (msg) => {
      document.getElementById("error").innerText = msg;
    });

    socket.on("authSuccess", ({ fio, centers, isAdmin: admin }) => {
      document.getElementById("login").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      document.getElementById("welcome").innerText = "“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑, " + fio;
      isAdmin = admin;

      document.getElementById("clearBtn").classList.toggle("hidden", !isAdmin);
      document.getElementById("reportBtn").classList.toggle("hidden", !isAdmin);

      window.centers = centers;
      renderCenters(centers);
    });

    socket.on("updateTopics", (centers) => {
      window.centers = centers;
      renderCenters(centers);
    });

    socket.on("topicError", (msg) => {
      alert(msg);
    });

    function renderCenters(centers) {
      const container = document.getElementById("centers");
      container.innerHTML = "";
      centers.forEach(center => {
        const div = document.createElement("div");
        div.innerHTML = `<h4>${center.name[currentLang]}</h4>`;
        center.topics.forEach(topic => {
          const tDiv = document.createElement("div");
          tDiv.className = "topic" + (topic.student ? " taken" : "");
          tDiv.innerHTML = `<b>${topic.title[currentLang]}</b><br>` +
            (topic.student ? `üë§ ${topic.student} <br> ‚è∞ ${topic.time}` : `<button onclick="chooseTopic('${center.name.kk}', ${topic.id})">–¢–∞“£–¥–∞—É</button>`);
          div.appendChild(tDiv);
        });
        container.appendChild(div);
      });
    }

    function chooseTopic(centerName, topicId) {
      socket.emit("chooseTopic", { fio: document.getElementById("welcome").innerText.replace("“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑, ", ""), centerName, topicId });
    }

    function clearAll() {
      socket.emit("clearAll");
    }

    function downloadReport() {
      window.location = "/downloadReport";
    }
  </script>
</body>
</html>
