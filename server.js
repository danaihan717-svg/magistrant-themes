const express = require('express');
const app = express();
const http = require('http').createServer(app);
const io = require('socket.io')(http);

app.use(express.static('public'));

// ะฆะตะฝััั ััะตะฑะฝัั ะฟัะพะณัะฐะผะผ ั ัะตะฐะปัะฝัะผะธ ัะตะผะฐะผะธ
let centers = [
  {
    name: "ะะตะผะปะตะบะตัััะบ-าาฑาัาััา ะฟำะฝะดะตัะดัาฃ าัะปัะผะธ-ะฑัะปัะผ ะฑะตัั ะพััะฐะปัาั",
    maxStudents: 31,
    topics: [
      "ะะพะฝััะธัััะธัะปัา าาฑาัาััาฃ ะดะฐะผั ัะตะฝะดะตะฝัะธัะปะฐัั",
      "ะะตะผะปะตะบะตัััะบ ะฑะฐัาะฐััะดัาฃ ะทะฐาฃะฝะฐะผะฐะปัา ะฝะตะณัะทะดะตัั",
      "าาฑาัาััา ะผะตะผะปะตะบะตั ะบะพะฝัะตะฟัะธััั",
      "ะะตะผะปะตะบะตัััะบ าัะทะผะตัััาฃ าาฑาัาััา ัะตะณะปะฐะผะตะฝัะฐัะธััั",
      "ะะทะฐะผะฐัััา ะถำะฝะต ัะฐััะธ าาฑาัาัะฐั",
      "ะกะฐะนะปะฐั าาฑาัาั ะถำะฝะต ัะฐะนะปะฐั ะทะฐาฃะฝะฐะผะฐัั",
      "ะะตะผะปะตะบะตัััะบ ะฑะฐาัะปะฐั ะถำะฝะต าะฐะดะฐาะฐะปะฐั ะพัะณะฐะฝะดะฐัั",
      "าาฑาัาััา ัะฐะปะฐะปะฐัะดะฐาั ะฝะพัะผะฐัะธะฒััะบ ะฐะบััะปะตัะดั ัะฐะปะดะฐั",
      "าาฑาัา าะพัาะฐั ะพัะณะฐะฝะดะฐััะฝัาฃ าัะทะผะตัั",
      "าาฑาัาััา ัะฐััะฐััั ะดะฐะผััั ะผำัะตะปะตะปะตัั",
      "ะะพะฝััะธัััะธัะปัา ัะพั ะฟัะฐะบัะธะบะฐัั",
      "ะะตะผะปะตะบะตัััะบ ะพัะณะฐะฝะดะฐัะดัาฃ ัะฐะปัาะฐัะฐะปัา าาฑาัาะฟะตะฝ ำฉะทะฐัะฐ ำัะตะบะตัั",
      "าาฑาัาััา ััะธะบะฐ ะถำะฝะต ะผะตะผะปะตะบะตัััะบ าัะทะผะตั",
      "ะะตัะณัะปัะบัั ำฉะทัะฝ-ำฉะทั ะฑะฐัาะฐัั ะผำัะตะปะตะปะตัั",
      "ะะตะผะปะตะบะตัััะบ ะฑัะดะถะตัััาฃ าาฑาัาััา ะฝะตะณัะทะดะตัั",
      "าะพาะฐะผะดัา-ัะฐััะธ าาฑััะปัะผะดะฐัะดั าาฑาัาััา ะทะตัััะตั",
      "าาฑาัาััา ะดะตัะตะบัะตัะดั ะฑะฐัาะฐัั ะถาฏะนะตะปะตัั",
      "ะกะพั ะฟัะฐะบัะธะบะฐัั ะถำะฝะต ะทะฐาฃะฝะฐะผะฐะปัา ัะตัะพัะผะฐะปะฐั",
      "ะะทะฐะผะฐัััา าะพาะฐะผ ะธะฝััะธััััะฐัั ะผะตะฝ าาฑาัาััา าะฐััะฝะฐััะฐัั",
      "ะะพะฝััะธัััะธัะปัา ะฑะฐาัะปะฐั ะถำะฝะต ะฝะพัะผะฐะปะฐัะดัาฃ าฏะนะปะตััะผะดัะปัะณั",
      "ะะตะผะปะตะบะตัััะบ าัะทะผะตัััะปะตัะดัาฃ าาฑาัาััา ะผำััะตะฑะตัั",
      "ะะตัะณัะปัะบัั ะถำะฝะต ะพััะฐะปัา ะฑะธะปัะบ ะฐัะฐััะฝะดะฐาั าาฑาัาััา ำฉะทะฐัะฐ ำัะตะบะตั",
      "าาฑาัาััา ัะตัะพัะผะฐ ะถำะฝะต ะทะฐาฃะฝะฐะผะฐะปัา ัาฑัะฐาััะปัา",
      "ำะบัะผััะปัะบ าาฑาัา ะถำะฝะต ำะบัะผััะปัะบ ะฟัะพัะตะดััะฐะปะฐั",
      "าาฑาัาััา าัะปัะผะดะฐ ะถะฐาฃะฐ ำะดัััะตั",
      "าาฑาัาััา ะผำะดะตะฝะธะตั ะฟะตะฝ าาฑาัาััา ัะฐะฝะฐ",
      "าาฑาัาััา ะฝะพัะผะฐะปะฐัะดั ะธะฝัะตัะฟัะตัะฐัะธัะปะฐั",
      "ะะตะผะปะตะบะตัััะบ ะพัะณะฐะฝะดะฐัะดัาฃ ะบะตะปัััะผ-ัะฐััััา าาฑาัาััา าะฐััะฝะฐััะฐัั",
      "าาฑาัาััา ะฐัะดะธั ะถำะฝะต ะผะพะฝะธัะพัะธะฝะณ",
      "าาฑาัาััา ะฑัะปัะผ ะฑะตััะดะตะณั ะธะฝะฝะพะฒะฐัะธัะปะฐั",
      "ะะตะผะปะตะบะตัััะบ าัะทะผะตััะตะณั าาฑาัาััา ะดะฐัะปะฐั",
      "าาฑาัาััา ะผำัะตะปะตะปะตัะดั ัะตััะดัาฃ ัะฐะปัาะฐัะฐะปัา ัำะถััะธะฑะตัั",
      "าาฑาัาััา ััะธะบะฐ ะถำะฝะต ะผะตะผะปะตะบะตัััะบ ัะฐััะฐั"
    ].map((title, idx) => ({ id: idx + 1, title, student: null, time: null }))
  },
  {
    name: "ะะทะฐะผะฐัััา-าาฑาัาััา ะฟำะฝะดะตัะดัาฃ าัะปัะผะธ-ะฑัะปัะผ ะฑะตัั ะพััะฐะปัาั",
    maxStudents: 31,
    topics: [
      "ะะทะฐะผะฐัััา าาฑาัา ะฝะตะณัะทะดะตัั",
      "ะะตะบะต าาฑาัา ััะฑัะตะบััะปะตัั",
      "ะะตะปัััะผ-ัะฐััััา าาฑาัา",
      "ะาฏะปัะบััะบ าาฑาัา ะถำะฝะต ะผะตะฝััะบ าะฐััะฝะฐััะฐัั",
      "ะะฒัะพัะปัา าาฑาัา ะถำะฝะต ะทะธััะบะตัะปัะบ ะผะตะฝััะบ",
      "ะะตะบะต ัาฑะปาะฐะฝัาฃ าาฑาัาััา าะพัาะฐัั",
      "าาฑาัาััา ะถะฐัะฐะฟะบะตัััะปัะบ",
      "ะัะฑะฐัั าาฑาัาั",
      "ะาฑัะฐะณะตัะปัะบ าาฑาัาั",
      "ะะทะฐะผะฐัััา ะฟัะพัะตัััะบ าาฑาัา",
      "ะะทะฐะผะฐัััา-ะฐัาะฐัััั าาฑาัา",
      "าาฑาัาััา ะบะตะปัััะผ-ัะฐัััะฐัะดั ัะฐะปะดะฐั",
      "ะาฏะปัะบัั าะพัาะฐั ะถำะฝะต ัะพั ัำะถััะธะฑะตัั",
      "ะะทะฐะผะฐัััา าะพาะฐะผะดะฐาั าาฑาัาััา ะผะตัะฐะฝะธะทะผะดะตั",
      "าาฑาัาััา ะฝะพัะผะฐะปะฐัะดั าะพะปะดะฐะฝั ะฟัะฐะบัะธะบะฐัั",
      "ะะตะบะต ะถำะฝะต ะทะฐาฃะดั ัาฑะปาะฐะปะฐัะดัาฃ าาฑาัาัะฐัั",
      "ะกะฐะปัา ะถำะฝะต ะฐะทะฐะผะฐัััา-าาฑาัาััา าะฐััะฝะฐััะฐั",
      "ะะตะฟัะปะดัะบ ะถำะฝะต ะฝะตัะธะตะปัะบ าาฑาัา",
      "ะะฝัะตะปะปะตะบััะฐะปะดั ะผะตะฝััะบ ะพะฑัะตะบััะปะตัั",
      "ะะทะฐะผะฐัััา าาฑาัาัะฐาั ะถะฐัะฐะฟะบะตัััะปัะบ",
      "าาฑาัาััา ัะฐาัะฐะฝะดััั ะถาฏะนะตัั",
      "ะะพะผะผะตััะธัะปัา าาฑาัา ะฝะตะณัะทะดะตัั",
      "ะะตะบะต ะผะตะฝััะบ ะฟะตะฝ ะบะพัะฟะพัะฐัะธะฒััะบ าะฐััะฝะฐััะฐั",
      "ะะทะฐะผะฐัััา าาฑาัาััา ัะตัะพัะผะฐะปะฐั",
      "ะาฏะปัะบััะบ าาฑาัาััา ะดะฐัะปะฐัะดั ัะตัั",
      "ะะทะฐะผะฐัััา าาฑาัาัะฐาั ะถะฐาฃะฐ ัะตัะฝะพะปะพะณะธัะปะฐั",
      "ะจะตัะตะปะดัะบ ัำะถััะธะฑะต ะถำะฝะต าาฑาัาััา ัะฐะปัััััั",
      "ะะตะบะต าาฑาัาััา ะฝะพัะผะฐะปะฐัะดั ะธะฝัะตัะฟัะตัะฐัะธัะปะฐั",
      "ะะทะฐะผะฐัััา าาฑาัาััา ะฐัะดะธั",
      "ะะทะฐะผะฐัััา-าาฑาัาััา าะฐััะฝะฐััะฐัะดะฐาั ััะธะบะฐ",
      "าาฑาัาััา ะบะตะปัััะผ-ัะฐัััะฐัะดัาฃ ัะธัะผะดัะปัะณั",
      "ะะทะฐะผะฐัััา าาฑาัาัะฐาั ะผะตะดะธะฐัะธั ะถำะฝะต ะฐะปััะตัะฝะฐัะธะฒััะบ ัะตััะผะดะตั",
      "าาฑาัาััา ะฟัะฐะบัะธะบะฐะดะฐาั ะธะฝะฝะพะฒะฐัะธัะปัา ำะดัััะตั"
    ].map((title, idx) => ({ id: idx + 1, title, student: null, time: null }))
  },
  {
    name: "าัะปะผััััา-าาฑาัาััา ะฟำะฝะดะตัะดัาฃ าัะปัะผะธ-ะฑัะปัะผ ะฑะตัั ะพััะฐะปัาั",
    maxStudents: 31,
    topics: [
      "าัะปะผััััา าาฑาัา ะฝะตะณัะทะดะตัั",
      "าัะปะผััััา ะถะฐัะฐะฟะบะตัััะปัะบััาฃ ะฟัะธะฝัะธะฟัะตัั",
      "าัะปะผััััา ัั ะถาฏัะณัะทั ะทะฐาฃะฝะฐะผะฐัั",
      "าัะปะผััััา าาฑาัาััาฃ ะถะตะบะต ะฑำฉะปัะผั",
      "าัะปะผััััา ะฟัะพัะตัััาฃ ััะฑัะตะบััะปะตัั",
      "าัะปะผััััา าาฑาัาัะฐาั ะถะฐะทะฐะปะฐั ะถาฏะนะตัั",
      "าัะปะผััััา าาฑาัาััา ะฟัะพัะธะปะฐะบัะธะบะฐ",
      "าัะปะผััััา ะทะตัััะตัะปะตั ะถำะฝะต ำะดัััะตั",
      "ะะตาฃัะป ะถำะฝะต ะฐััั าัะปะผัััะฐั",
      "าาฑาัา าะพัาะฐั ะพัะณะฐะฝะดะฐััะฝัาฃ ัั-ำัะตะบะตัั",
      "าัะปะผััััา ัััะตัะดั ัะตัะณะตั ะฟัะฐะบัะธะบะฐัั",
      "ะกะพั ัะฐัะฐะฟัะฐะผะฐะปะฐัั ะถำะฝะต าัะปะผััััา ะดำะปะตะปะดะตั",
      "าัะปะผััััา ะทะฐาฃะฝะฐะผะฐะฝั ะธะฝัะตัะฟัะตัะฐัะธัะปะฐั",
      "าาฑาัาััา ััะธะบะฐ าัะปะผััััา ะฟัะพัะตััะต",
      "าัะปะผััััา าาฑาัาัะฐาั ัะฐะปัาะฐัะฐะปัา ััะฐะฝะดะฐัััะฐั",
      "าัะปะผััััา ะถะฐัะฐะฟะบะตัััะปัะบัั ะถะตาฃัะปะดะตัั ะถำะฝะต ะฐัััะปะฐัั",
      "าัะปะผััััา าาฑาัาัะฐาั ะถะฐาฃะฐ ัะตะฝะดะตะฝัะธัะปะฐั",
      "าัะปะผััััา ะฟัะพัะตัััาฃ าะฐััััััะปะฐัั",
      "าัะปะผััััา าาฑาัาััา ะดะฐัะปะฐัะดั ัะตัั",
      "าัะปะผััััา าาฑาัาัะฐาั ะฟัะพัะธะปะฐะบัะธะบะฐะปัา ัะฐัะฐะปะฐั",
      "ะะฐััะฐั ะฐัะฐััะฝะดะฐาั าาฑาัา ะฑาฑะทัััะปัา",
      "าัะปะผััััา าาฑาัาััา ะฑัะปัะผ ะฑะตัั",
      "าัะปะผััััา าาฑาัา ะถำะฝะต ะฐาะฟะฐัะฐัััา าะฐััะฟััะทะดัะบ",
      "าัะปะผััััา าาฑาัาัะฐาั ะผะตะดะธะฐัะธะฒััะบ ำะดัััะตั",
      "าัะปะผััััา ะถะฐะทะฐะปะฐัะดั ะพััะฝะดะฐั ะฟัะฐะบัะธะบะฐัั",
      "าัะปะผััััา าาฑาัาัะฐาั ะธะฝะฝะพะฒะฐัะธัะปัา ำะดัััะตั",
      "าัะปะผััััา าาฑาัาัะฐาั ัะตัะตะปะดัะบ ัำะถััะธะฑะต",
      "าัะปะผััััา าาฑาัาัะฐาั ัะปะตะบััะพะฝะดั ะดำะปะตะปะดะตั",
      "าัะปะผััััา าาฑาัาัะฐาั ะทะตัััะตั ำะดัััะตัั",
      "าาฑาัา าะพัาะฐั ะพัะณะฐะฝะดะฐััะฝัาฃ าัะทะผะตััะฝ ัะฐะปะดะฐั",
      "าัะปะผััััา ะฟัะพัะตัััาฃ ะทะฐาฃะดัา ะฐัะฟะตะบััะปะตัั",
      "าัะปะผััััา าาฑาัาัะฐาั ะผะตะดะธะฐัะพัะปัา ัำะถััะธะฑะต",
      "าัะปะผััััา าาฑาัาัะฐาั าาฑาัาััา ะถะฐาฃะฐะปัาัะฐั"
    ].map((title, idx) => ({ id: idx + 1, title, student: null, time: null }))
  }
];

// ะััะปะตะถะธะฒะฐะฝะธะต ะฒัะฑัะฐะฝะฝะพะณะพ ัะตะฝััะฐ ะบะฐะถะดัะผ ัััะดะตะฝัะพะผ
let studentCenter = {}; // { "ะคะะ ัััะดะตะฝัะฐ": "ะะฐะทะฒะฐะฝะธะต ัะตะฝััะฐ" }

io.on('connection', (socket) => {
  console.log("๐ ะะฐาฃะฐ ะผะฐะณะธัััะฐะฝั าะพััะปะดั");

  socket.on('registerStudent', (fio) => {
    socket.fio = fio;
    console.log(`โ ะขััะบะตะปะดั: ${fio}`);
    socket.emit('topicsList', centers);
  });

  socket.on('chooseTopic', ({ fio, centerName, topicId }) => {

    // ะัะพะฒะตัะบะฐ: ะตัะปะธ ัััะดะตะฝั ัะถะต ะฒัะฑัะฐะป ะดััะณะพะน ัะตะฝัั
    if(studentCenter[fio] && studentCenter[fio] !== centerName){
      socket.emit('topicError', `โ๏ธ ะกัะท ะฑาฑััะฝ ะฑะฐัาะฐ ะพััะฐะปัาัะฐะฝ ัะฐาัััะฟ ัะฐาฃะดะฐะดัาฃัะท. ะาฑะป ะพััะฐะปัาาะฐ ัะฐาฃะดะฐั ะผาฏะผะบัะฝ ะตะผะตั!`);
      return;
    }

    const center = centers.find(c => c.name === centerName);
    if (!center) return;

    let selectedCount = center.topics.filter(t => t.student).length;
    if (selectedCount >= center.maxStudents) {
      socket.emit('topicError', `โ ะาฑะป ะพััะฐะปัาัะฐ ัะฐาฃะดะฐัาะฐ ัาฑาัะฐั ะถะพา (ัะพะปัา)!`);
      return;
    }

    let topic = center.topics.find(t => t.id === topicId);
    if (!topic) return;

    if (topic.student) {
      socket.emit('topicError', "โ ะาฑะป ัะฐาัััะฟ ัะพะปั!");
      return;
    }

    // ะัะพะฒะตัะบะฐ: ัััะดะตะฝั ัะถะต ะฒัะฑัะฐะป ัะตะผั ะฒ ััะพะผ ัะตะฝััะต
    let already = center.topics.find(t => t.student === fio);
    if (already) {
      socket.emit('topicError', "โ๏ธ ะกัะท ะฑาฑะป ะพััะฐะปัาัะฐะฝ ัะฐาัััะฟ ัะฐาฃะดะฐะดัาฃัะท!");
      return;
    }

    // ะะฐะบัะตะฟะปะตะฝะธะต ัะตะผั
    topic.student = fio;
    topic.time = new Date().toLocaleString("kk-KZ", { timeZone: "Asia/Almaty" });

    // ะะฐะฟะพะผะธะฝะฐะตะผ, ะบะฐะบะพะน ัะตะฝัั ะฒัะฑัะฐะป ัััะดะตะฝั
    studentCenter[fio] = centerName;

    console.log(`๐ ${fio} ัะฐาฃะดะฐะดั: ${topic.title}`);
    io.emit('topicsList', centers);
  });

  socket.on('disconnect', () => {
    if (socket.fio) console.log(`โ ะจัาัะฟ ะบะตััั: ${socket.fio}`);
  });
});

// CSV ะพััะตั
app.get('/downloadReport', (req, res) => {
  let csv = "ะขะพะปัา ะฐัั-ะถำฉะฝั,ะฆะตะฝัั,ะขะฐาัััะฟ,ะขะฐาฃะดะฐั ัะฐาััั\n";
  centers.forEach(center => {
    center.topics.forEach(t => {
      if (t.student) csv += `${t.student},${center.name},${t.title},${t.time}\n`;
    });
  });
  res.setHeader('Content-Type', 'text/csv');
  res.setHeader('Content-Disposition', 'attachment; filename=report.csv');
  res.send(csv);
});

http.listen(3000, () => {
  console.log("๐ ะกะตัะฒะตั ััะบะต าะพััะปะดั: http://localhost:3000");
});
